/*
 * CssJserBlog
 * v0.0.1
 * 2014-04-22
 **/
define(["utils/dropdown","utils/notification","utils/moment","prettify/prettify"],function(a){function b(a,b){d.ajax({url:"/api/post/getAll/",data:a,dataType:"json",success:function(a){var f='<li><a class="permalink" href="#"><h3 class="entry-title">@title</h3><section class="entry-meta" data-time="@time"><time class="date">@formNow</time></section></a></li>';a.list&&d.each(a.list,function(a,b){var g=d(f.replace("@title",b.title).replace("@time",b.updateTime).replace("@formNow",e(b.updateTime).fromNow()));g.data("post",JSON.stringify(b)),j.append(g),0===a&&j.find(".active").length<1&&(g.addClass("active"),c(b))}),a.list.length<15&&i.off("scroll"),b&&b(a.list)},error:function(a){var b="";try{b=d.parseJSON(a.response).error}catch(c){b=a}g.show({type:f.MessageTypes.error,info:b})}})}function c(a){h.find(".content-preview-content").scrollTop(0),h.find(".status").text(a.status),h.find(".author").text(a.author.name),h.find(".post-edit").attr("href","/admin/posts/editor/"+a._id+"/"),h.find(".post-delete").data("post-id",a._id),h.find(".render-markdown").html("<h1>"+a.title+"</h1>"),h.find(".render-markdown").append(a.html),setTimeout(function(){prettyPrint()},0)}var d=(a("utils/dropdown"),a("jquery")),e=a("utils/moment"),f=a("utils/notification"),g=(a("prettify/prettify"),new f.Message),h=d("#js-preview"),i=d("#js-content-list"),j=i.find("ol"),k=1,l=!1;i.on("scroll",function(){var a=d(this).height(),c=d(this).scrollTop(),e=j.height(),f=50;a+c+f>=e&&!l&&(l=!0,b({page:++k},function(){l=!1}))}),b({page:k}),j.on("click","li",function(a){var b;return d(a.currentTarget).hasClass("active")||(b=d(a.currentTarget).data("post"),j.find("li").removeClass("active"),d(a.currentTarget).addClass("active"),c(b)),!1}),h.on("click",".post-delete",function(a){var b=d(a.currentTarget).data("post-id"),c=window.confirm("确定删除这篇文章么？");return b&&c&&d.ajax({url:"/api/post/delete/",type:"post",data:{id:b},dataType:"json",headers:{"X-CSRF-Token":d("meta[name='csrf-param']").attr("content")},success:function(a){a.post&&(j.find("li.active").remove(),j.find("li").eq(0).click())},error:function(){var a="";try{a=d.parseJSON(error.response).error}catch(b){a=error}g.show({type:f.MessageTypes.error,info:a})}}),!1})});
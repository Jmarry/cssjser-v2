/*
 * CssJserBlog
 * v0.0.1
 * 2014-04-22
 **/
define(["utils/dropdown","utils/notification","codemirror/lib/codemirror","codemirror/mode/markdown/markdown","showdown/showdown","showdown/extensions/github","showdown/extensions/table","showdown/extensions/prettify","prettify/prettify","tags/tagfield"],function(a){var b,c=(a("utils/dropdown"),a("jquery")),d=a("utils/notification"),e=a("codemirror/lib/codemirror"),f=(a("codemirror/mode/markdown/markdown"),a("showdown/showdown")),g=a("showdown/extensions/github"),h=a("showdown/extensions/table"),i=a("showdown/extensions/prettify"),j=(a("prettify/prettify"),a("tags/tagfield"),c("#postUrl")),k=j.next().find(".slug"),l=new f.converter({extensions:[g,h,i]}),m=e.fromTextArea(c("#entry-markdown")[0],{mode:"markdown",lineWrapping:!0,theme:"default"}),n=new d.Message;c("#post-title").on("input",function(){var a=c(this).val();clearTimeout(b),a&&(b=setTimeout(function(){c.ajax({url:"http://openapi.baidu.com/public/2.0/bmt/translate",data:{client_id:G_CONFIG.bae.ApiKey,q:a,from:"zh",to:"en"},dataType:"jsonp",success:function(a){if(a.error_code)n.show({type:d.MessageTypes.error,info:a.error_msg});else{var b=[];c.each(a.trans_result,function(a,c){var d=c.dst.split(" ");b.push(d.join("-"))}),b=b.join("-").toLowerCase(),c("#postUrl").val(b),k.html(b)}}})},300))}),c(".post-content").on("click","header.floatingHeader",function(a){var b=c(a.currentTarget).parent();return b.hasClass("active")?!1:(b.siblings().removeClass("active"),b.addClass("active"),b.hasClass("entry-preview")&&(b.find(".render-markdown").html(l.makeHtml(m.getValue())),setTimeout(function(){prettyPrint()},0)),!1)}),k.html(j.val()),j.on("input",function(){k.html(c(this).val())}),c.ajax({url:"/api/tag/getAll/",dataType:"json",headers:{"X-CSRF-Token":c("meta[name='csrf-param']").attr("content")},success:function(a){var b=[];c.each(a.tags,function(a,c){b.push(c.name)}),c("#postTags").tagbox({url:b})},error:function(a){var b="";try{b=c.parseJSON(a.response).error}catch(e){b=a}n.show({type:d.MessageTypes.error,info:b})}}),c("#post").on("submit",function(){return!1}).find(".button-post").on("click",function(){var a=c("#post-title").val(),b=m.getValue(),e=c("#postTags").val(),f=j.val(),g=c("#postId").val();return a?b?f?(c.ajax({url:g?"/api/post/update/":"/api/post/create/",type:"post",dataType:"json",data:{title:a,markdown:b,tags:e,slug:f,postId:g},headers:{"X-CSRF-Token":c("meta[name='csrf-param']").attr("content")},success:function(a){window.location.href=a.redirect},error:function(a){var b="";try{b=c.parseJSON(a.response).error}catch(e){b=a}n.show({type:d.MessageTypes.error,info:b})}}),!1):(n.show({info:"链接不能为空",type:d.MessageTypes.error}),!1):(n.show({info:"内容不能为空",type:d.MessageTypes.error}),!1):(n.show({info:"标题不能为空",type:d.MessageTypes.error}),!1)})});